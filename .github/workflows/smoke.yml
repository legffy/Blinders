name: Smoke CI

on:
  push:
    branches: [ main ]
    paths:
      - "api/**"
      - "web/**"
      - "extensionVite/**"
      - ".github/workflows/smoke.yml"
  pull_request:
    paths:
      - "api/**"
      - "web/**"
      - "extensionVite/**"

jobs:
  api:
    if: contains(github.event.head_commit.message, '[skip-ci]') == false
    name: API (FastAPI builds)
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{secrets.DATABASE_URL}}
      JWT_SECRET: ${{secrets.JWT_SECRET}}
    defaults: { run: { working-directory: api } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements.txt
      - run: python -c "import app, app.main; print('app ok')"

  web:
    name: Web (Next.js builds)
    runs-on: ubuntu-latest
    defaults: { run: { working-directory: web } }
    steps:
      - uses: actions/checkout@v4
      - name: Ensure npm cache dir exists
        run: mkdir -p ~/.npm
      - uses: actions/setup-node@v4
        with: { node-version: "20", cache: "npm", cache-dependency-path: "web/package-lock.json" }
      - run: npm ci
      - run: NEXT_PUBLIC_API_URL=https://example.com npm run build

  extension:
    name: Extension (Vite builds + zip)
    runs-on: ubuntu-latest
    defaults: { run: { working-directory: extensionVite } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20", cache: "npm", cache-dependency-path: "extensionVite/package-lock.json" }
      - run: npm ci
      - run: npm run build
      - run: cd dist && zip -r ../blinders-extension.zip .
      - uses: actions/upload-artifact@v4
        with: { name: blinders-extension, path: extensionVite/blinders-extension.zip }
